<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="jquery-1.7.1.min.js"></script>
<style type="text/css">
body { font-family:arial; font-size:.8em; }
#container { width:400px; position:absolute; top:50%; left:50%; margin:-170px 0 0 -200px; background:#dfdfdf; padding:20px; border-radius:15px; text-align:center; }
.notice { color:red; }
input[type="button"] { width:100px; }
#bar { width:300px; height:20px; }
.hidden { display:none; }
.timeoutSeconds { width:40px; }
.optionList {     list-style-type:none;     margin:0;     padding:0; }
</style>
<script>

$(document).ready(function()
{
    isNaN(localStorage['timeoutSeconds']) ? $('.timeoutSeconds').val(10) : $('.timeoutSeconds').val(localStorage['timeoutSeconds'])
    $('.timeoutSeconds').click(function()
    {
        localStorage['timeoutSeconds'] = isNaN($('.timeoutSeconds').val()) ?  10 : $('.timeoutSeconds').val();
    });
});

function startIt() {
    document.getElementById("stop").className = "hidden";
    document.getElementById("bar").className = "hidden";
    chrome.bookmarks.getTree(function(bookmarks) {
        getBookmarks(bookmarks);
        document.getElementById("bar").max = urls.length;
    });
}
var urls = new Array();
var i = 0;
var stop = false;
var currTab = null;
var currId = null;

//Thanks to http://stackoverflow.com/questions/2812622/how-do-i-get-google-chromes-root-bookmarks-folder/2815066#2815066
function getBookmarks(bookmarks){ 
    bookmarks.forEach(function(bm){
        if(bm.url){
            if(bm.url.substring(0,10) != "javascript")
                urls.push(bm.url);
        }
        if (bm.children)
        getBookmarks(bm.children);
    });
}

/*
Checks to see if the bookmark we loaded below is fully loaded,
if so we will close it then open the next one. 
*/

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    if(tabId == currId && tab.status == "complete") {
        setTimeout("removeTab()",1000);
    }
});

function removeTab() {
    document.getElementById("bar").value++;
    if(currTab != null)
        chrome.tabs.remove(currId);
    if(i < urls.length) {
        fixFavicons();
    }
    else
    {
        document.getElementById("message").innerHTML = "Completed!";
        doStop();
    }
}
//Goes through the next bookmark. Starting at the first one.
function fixFavicons() {
    if(!stop) {
        chrome.tabs.create({'url':urls[i], 'selected':false}, function(tab) {
            i++;
            currId = tab.id;
            currTab = tab;
            setTimeout(checkHang, localStorage['timeoutSeconds'] * 1000, currId);
        });
    }
}

function checkHang(id)
{
    if(currId == id)
        removeTab();
}

function doStart() {
    stop=false;
    fixFavicons();
    document.getElementById("start").className = "hidden";
    document.getElementById("stop").className = "";
    document.getElementById("bar").className = "";
    document.getElementById("message").innerHTML = "";
}
function doStop() {
    i = 0;
    currTab = null;
    currId = null;
    stop=true;
    document.getElementById("start").className = "";
    document.getElementById("stop").className = "hidden";
    document.getElementById("bar").value = 0;
    document.getElementById("bar").className = "hidden";
}
</script>
</head>
<body onload="startIt();">
<div id="container">
    <h2>Bookmark Favicon Fixer</h2>
    <p class="notice">This will open all your bookmarks and reload the favicons. Tabs will stay open for about 1 second after they load to ensure the favicon is grabbed.</p><br />
    <input type="button" value="Start" id="start" onclick="doStart();" />
    <input type="button" value="Stop" id="stop" onclick="doStop();" /><br /><br />
    <progress id="bar" value="0" max="100"></progress><br />
    <span id="message"></span>
    <div class="options">
    <ul class="optionList">
        <li><input type="number" min="1" class="timeoutSeconds"/> Maximum number of seconds to wait for a tab to load</li>
    <ul>
    </div>
</div>
</body>
</html>